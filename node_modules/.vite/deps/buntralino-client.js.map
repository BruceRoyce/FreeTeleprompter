{
  "version": 3,
  "sources": ["../../buntralino-client/src/listeners.ts", "../../buntralino-client/src/index.ts"],
  "sourcesContent": ["let bunWs: WebSocket,\n    bunToken: string;\n\nconst evalHandler = async (payload: {\n    detail: {\n        js: string,\n        requestId: string\n    }\n}) => {\n    try {\n        // eslint-disable-next-line no-eval\n        const val = await (0, eval)(payload.detail.js);\n        // ‚¨ÜÔ∏è (0, eval) is used to execute the code in global scope\n        bunWs.send(JSON.stringify({\n            token: bunToken,\n            command: 'execResult',\n            id: payload.detail.requestId,\n            returnValue: val\n        }));\n    } catch (e) {\n        bunWs.send(JSON.stringify({\n            token: bunToken,\n            command: 'execResult',\n            id: payload.detail.requestId,\n            error: e.message,\n            stack: e.stack\n        }));\n    }\n};\n\nexport default async (\n    neutralino: Awaited<typeof import('@neutralinojs/lib')>,\n    token: string,\n    ws: WebSocket\n) => {\n    bunWs = ws;\n    bunToken = token;\n    neutralino.events.on('buntralinoEval', evalHandler);\n    neutralino.events.on('buntralinoNavigate', (event: {\n        detail: {\n            url: string\n        }\n    }) => {\n        window.location.href = event.detail.url;\n    });\n    neutralino.events.on('buntralinoReload', () => {\n        window.location.reload();\n    });\n};\n", "import listeners from './listeners';\nconst getUid = () => Date.now().toString(36) + Math.random().toString(36);\n\nlet neutralino: Awaited<typeof import('@neutralinojs/lib')>;\nif (window.Neutralino) {\n    neutralino = window.Neutralino;\n}\n\nlet bunToken: string, bunPort: number, bunWs: WebSocket;\nlet readyResolve: (value: void | PromiseLike<void>) => void,\n    readyReject: (reason?: Error) => void;\nconst readyPromise = new Promise<void>((resolve, reject) => {\n    readyResolve = resolve;\n    readyReject = reject;\n});\n\nlet bunCheckEnabled = true;\nexport const disableBunCheck = () => {\n    bunCheckEnabled = false;\n};\n\n(async () => {\n    if (!neutralino!) {\n        neutralino = (await import('@neutralinojs/lib')).default;\n    }\n    neutralino.events.on('ready', async () => {\n        // Firstly check that this window was opened with Buntralino\n        if (bunCheckEnabled &&\n            window.NL_RESMODE === 'bundle' &&\n            !window.NL_ARGS.some(a => a.startsWith('--buntralino-name='))\n        ) {\n            // Open the actual Buntralino app and exit\n            const config = await neutralino.app.getConfig();\n            let execPath = `${window.NL_CWD}/${config.cli.binaryName}`;\n            if (window.NL_OS === 'Windows') {\n                execPath += '.exe';\n            }\n            try {\n                // Check if the file exists\n                neutralino.filesystem.getStats(execPath);\n                // Run the proper executable and detach it\n                await neutralino.os.execCommand(`\"${execPath}\"`, {\n                    background: true,\n                    cwd: window.NL_CWD\n                });\n                neutralino.app.exit();\n            } catch (error) {\n                window.alert('\"neutralino\" is not the main executable! Please run the other one.');\n                neutralino.app.exit();\n            } finally {\n                return;\n            }\n        }\n\n        // Try connecting to Buntralino\n        try {\n            const match1 = window.NL_ARGS.find(a => a.startsWith('--buntralino-port=')),\n                  match2 = window.NL_ARGS.find(a => a.startsWith('--buntralino-name='));\n            if (!match1 || !match2) {\n                return;\n            }\n            const [, port] = match1.split('=');\n            const [, name] = match2.split('=');\n            const neuToken = window.NL_TOKEN || sessionStorage.NL_TOKEN;\n            bunWs = new WebSocket(`ws://127.0.0.1:${port}`);\n            bunWs.onopen = () => {\n                // eslint-disable-next-line no-console\n                console.debug('‚öõÔ∏è Announcing ourself to Buntralino‚Ä¶');\n                bunWs.send(JSON.stringify({\n                    command: 'announceSelf',\n                    name,\n                    NL_PORT: window.NL_PORT,\n                    NL_TOKEN: neuToken\n                }));\n            };\n\n            const listener = (payload: {\n                detail: {\n                    token: string,\n                    port: number\n                }\n            }) => {\n                neutralino.events.off('buntralinoRegisterParent', listener);\n                if (!payload.detail.token || !payload.detail.port) {\n                    return;\n                }\n                bunToken = payload.detail.token;\n                bunPort = payload.detail.port;\n                bunWs = new WebSocket(`ws://127.0.0.1:${bunPort}`);\n                bunWs.onopen = () => {\n                    listeners(neutralino, bunToken, bunWs);\n                    // eslint-disable-next-line no-console\n                    console.log('‚öõÔ∏èü•ü Buntralino connected on port', bunPort);\n                    readyResolve();\n                };\n            };\n            neutralino.events.on('buntralinoRegisterParent', listener);\n        } catch (error) {\n            readyReject(error);\n            console.error('‚öõÔ∏è Buntralino failed with', error);\n        }\n    });\n    // Initialize Neutralino just in case the app developer didn't do it themselves\n    neutralino.init();\n})();\n\n/**\n * Runs a method registered through registerMethod or registerMethodMap on Bun side.\n * Payload can be any JSON serializable value.\n * Returns a Promise that resolves with the result of the method or rejects with an Error.\n *\n * Example:\n * ```js\n * await buntralino.run('downloadFile', {\n *     src: 'https://secret.bunnies.io/builds/windows.exe',\n *     dest: 'dependencies/secretBunnies.exe'\n * });\n * ```\n */\nexport const run = async (methodName: string, payload?: unknown): Promise<unknown> => {\n    await readyPromise;\n    const awaitedResponseId = getUid();\n    bunWs.send(JSON.stringify({\n        token: bunToken,\n        command: 'run',\n        method: methodName,\n        id: awaitedResponseId,\n        payload\n    }));\n    return new Promise<unknown>((resolve, reject) => {\n        const listener = (event: CustomEvent<{\n            id: string,\n            returnValue?: unknown,\n            error?: string | null,\n            stack?: string | null\n        }>) => {\n            const {id, returnValue, error, stack} = event.detail;\n            if (id === awaitedResponseId) {\n                neutralino.events.off('buntralinoExecResult', listener);\n                if ('error' in event.detail) {\n                    reject(new Error(error ?? 'Unknown error', {\n                        cause: stack ? new Error(stack) : null\n                    }));\n                }\n                resolve(returnValue);\n            }\n        };\n        neutralino.events.on('buntralinoExecResult', listener);\n    });\n};\n\n/**\n * Fully shuts down the Buntralino app.\n */\nexport const shutdown = () => {\n    bunWs.send(JSON.stringify({\n        token: bunToken,\n        command: 'shutdown'\n    }));\n};\n\n/**\n * Sends an event with additional event.detail value to all the Neutralino instances.\n *\n * Example:\n * ```js\n * buntralino.broadcast('newUpdate', {\n *     version: '1.4.2'\n * });\n * ```\n */\nexport const broadcast = (eventName: string, payload: unknown) => {\n    bunWs.send(JSON.stringify({\n        token: bunToken,\n        command: 'broadcast',\n        event: eventName,\n        payload\n    }));\n};\n/**\n * Sends an event with additional event.detail value to a specific named Neutralino instance.\n *\n * Example:\n * ```js\n * buntralino.sendEvent('main', 'loginSuccessful', {\n *     username: 'Doofus3000'\n * });\n * ```\n */\nexport const sendEvent = (target: string, eventName: string, payload?: unknown) => {\n    bunWs.send(JSON.stringify({\n        token: bunToken,\n        command: 'sendEvent',\n        event: eventName,\n        target,\n        payload\n    }));\n};\n\n/**\n * A Promise that resolves when the Buntralino client is ready to accept commands.\n */\nexport const ready = readyPromise;\n\nexport default {\n    run,\n    ready,\n    shutdown,\n    broadcast,\n    sendEvent\n};\n"],
  "mappings": "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",
  "names": []
}
